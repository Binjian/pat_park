%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%考虑tan(delta)到delta转换带来的误差
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
LtoR=-1.2:0.001:1.2; %后轴中心点
FrontWheelAngle=atan(LtoR);
% LtoR=-0.866:0.001:0.866; %前轴中心点
% FrontWheelAngle=asin(LtoR);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%车速到预瞄时间的查表
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
PreView_LongitudinalSpeed=[0:5:50];
PreView_Time=[0.2 0.25 0.3 0.35 0.4 0.45 0.5 0.6 0.7 0.8 0.9];


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%according Front wheel angle to calculate steering angle 查表
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
DeltaR=[-31.1712000000000,-31.1712000000000,-30.8458000000000,-30.5204000000000,-30.1949000000000,-29.8692000000000,-29.5436000000000,-29.2179000000000,-28.8922000000000,-28.5667000000000,-28.2412000000000,-27.9160000000000,-27.5911000000000,-27.2665000000000,-26.9423000000000,-26.6185000000000,-26.2952000000000,-25.9724000000000,-25.6502000000000,-25.3285000000000,-25.0075000000000,-24.6870000000000,-24.3670000000000,-24.0475000000000,-23.7286000000000,-23.4099000000000,-23.0917000000000,-22.7736000000000,-22.4557000000000,-22.1379000000000,-21.8202000000000,-21.5024000000000,-21.1845000000000,-20.8665000000000,-20.5484000000000,-20.2301000000000,-19.9118000000000,-19.5933000000000,-19.2747000000000,-18.9561000000000,-18.6375000000000,-18.3188000000000,-18.0002000000000,-17.6817000000000,-17.3634000000000,-17.0452000000000,-16.7272000000000,-16.4095000000000,-16.0921000000000,-15.7749000000000,-15.4581000000000,-15.1416000000000,-14.8254000000000,-14.5095000000000,-14.1938000000000,-13.8783000000000,-13.5630000000000,-13.2478000000000,-12.9326000000000,-12.6173000000000,-12.3020000000000,-11.9865000000000,-11.6708000000000,-11.3549000000000,-11.0387000000000,-10.7222000000000,-10.4055000000000,-10.0884000000000,-9.77104000000000,-9.45338000000000,-9.13545000000000,-8.81727000000000,-8.49886000000000,-8.18025000000000,-7.86145000000000,-7.54250000000000,-7.22343000000000,-6.90426000000000,-6.58502000000000,-6.26573000000000,-5.94641000000000,-5.62704000000000,-5.30764000000000,-4.98820000000000,-4.66870000000000,-4.34911000000000,-4.02940000000000,-3.70954000000000,-3.38946000000000,-3.06913000000000,-2.74851000000000,-2.42754000000000,-2.10618000000000,-1.78440000000000,-1.46213000000000,-1.13935000000000,-0.816012000000000,-0.492093000000000,-0.167567000000000,0.157588000000000,0.483387000000000,0.809840000000000,1.13695000000000,1.46473000000000,1.79315000000000,2.12222000000000,2.45194000000000,2.78228000000000,3.11324000000000,3.44479000000000,3.77693000000000,4.10963000000000,4.44292000000000,4.77678000000000,5.11123000000000,5.44627000000000,5.78191000000000,6.11818000000000,6.45510000000000,6.79271000000000,7.13104000000000,7.47013000000000,7.81003000000000,8.15080000000000,8.49248000000000,8.83513000000000,9.17884000000000,9.52367000000000,9.86969000000000,10.2169000000000,10.5655000000000,10.9154000000000,11.2668000000000,11.6195000000000,11.9738000000000,12.3296000000000,12.6869000000000,13.0457000000000,13.4061000000000,13.7680000000000,14.1314000000000,14.4965000000000,14.8630000000000,15.2312000000000,15.6010000000000,15.9723000000000,16.3453000000000,16.7200000000000,17.0963000000000,17.4744000000000,17.8543000000000,18.2360000000000,18.6196000000000,19.0053000000000,19.3930000000000,19.7830000000000,20.1753000000000,20.5702000000000,20.9677000000000,21.3680000000000,21.7713000000000,22.1777000000000,22.5875000000000,23.0006000000000,23.4174000000000,23.8378000000000,24.2621000000000,24.6903000000000,25.1226000000000,25.5592000000000,26,26.4452000000000,26.8951000000000,27.3496000000000,27.8091000000000,28.2736000000000,28.7433000000000,29.2185000000000,29.6994000000000,30.1862000000000,30.6793000000000,31.1789000000000,31.6855000000000,32.1994000000000,32.7212000000000,33.2515000000000,33.7908000000000,34.3399000000000,34.8997000000000,35.4710000000000,36.0548000000000,36.6523000000000,37.2647000000000,37.8934000000000,38.5401000000000,39.2065000000000,39.8138];%右前轮转角
DeltaL=[-39.8321000000000,-39.8320000000000,-39.1487000000000,-38.4854000000000,-37.8401000000000,-37.2112000000000,-36.5973000000000,-35.9974000000000,-35.4103000000000,-34.8352000000000,-34.2714000000000,-33.7181000000000,-33.1748000000000,-32.6410000000000,-32.1162000000000,-31.6000000000000,-31.0919000000000,-30.5916000000000,-30.0988000000000,-29.6131000000000,-29.1341000000000,-28.6616000000000,-28.1952000000000,-27.7347000000000,-27.2796000000000,-26.8296000000000,-26.3845000000000,-25.9439000000000,-25.5075000000000,-25.0750000000000,-24.6463000000000,-24.2210000000000,-23.7990000000000,-23.3800000000000,-22.9641000000000,-22.5509000000000,-22.1405000000000,-21.7328000000000,-21.3276000000000,-20.9250000000000,-20.5249000000000,-20.1272000000000,-19.7320000000000,-19.3393000000000,-18.9489000000000,-18.5610000000000,-18.1755000000000,-17.7923000000000,-17.4115000000000,-17.0331000000000,-16.6569000000000,-16.2830000000000,-15.9113000000000,-15.5417000000000,-15.1741000000000,-14.8084000000000,-14.4446000000000,-14.0824000000000,-13.7218000000000,-13.3627000000000,-13.0050000000000,-12.6485000000000,-12.2932000000000,-11.9391000000000,-11.5860000000000,-11.2339000000000,-10.8827000000000,-10.5325000000000,-10.1832000000000,-9.83480000000000,-9.48731000000000,-9.14074000000000,-8.79510000000000,-8.45040000000000,-8.10665000000000,-7.76387000000000,-7.42208000000000,-7.08130000000000,-6.74154000000000,-6.40282000000000,-6.06515000000000,-5.72849000000000,-5.39285000000000,-5.05819000000000,-4.72450000000000,-4.39173000000000,-4.05985000000000,-3.72878000000000,-3.39848000000000,-3.06888000000000,-2.73994000000000,-2.41160000000000,-2.08381000000000,-1.75651000000000,-1.42966000000000,-1.10322000000000,-0.777149000000000,-0.451418000000000,-0.126004000000000,0.199110000000000,0.523937000000000,0.848483000000000,1.17275000000000,1.49673000000000,1.82041000000000,2.14379000000000,2.46685000000000,2.78958000000000,3.11196000000000,3.43397000000000,3.75558000000000,4.07680000000000,4.39762000000000,4.71803000000000,5.03805000000000,5.35767000000000,5.67690000000000,5.99575000000000,6.31424000000000,6.63239000000000,6.95023000000000,7.26778000000000,7.58507000000000,7.90214000000000,8.21901000000000,8.53573000000000,8.85235000000000,9.16891000000000,9.48544000000000,9.80199000000000,10.1186000000000,10.4352000000000,10.7519000000000,11.0688000000000,11.3857000000000,11.7027000000000,12.0199000000000,12.3371000000000,12.6543000000000,12.9716000000000,13.2890000000000,13.6063000000000,13.9236000000000,14.2408000000000,14.5580000000000,14.8751000000000,15.1922000000000,15.5091000000000,15.8260000000000,16.1427000000000,16.4593000000000,16.7758000000000,17.0922000000000,17.4085000000000,17.7248000000000,18.0411000000000,18.3574000000000,18.6737000000000,18.9902000000000,19.3069000000000,19.6239000000000,19.9411000000000,20.2586000000000,20.5765000000000,20.8948000000000,21.2134000000000,21.5324000000000,21.8518000000000,22.1715000000000,22.4916000000000,22.8120000000000,23.1326000000000,23.4535000000000,23.7747000000000,24.0960000000000,24.4175000000000,24.7391000000000,25.0608000000000,25.3827000000000,25.7045000000000,26.0264000000000,26.3483000000000,26.6703000000000,26.9922000000000,27.3143000000000,27.6364000000000,27.9586000000000,28.2810000000000,28.6036000000000,28.9265000000000,29.2498000000000,29.5735000000000,29.8977000000000,30.2223000000000,30.5476000000000,30.8733000000000,31.1618];%左前轮转角
SteeringAngle=[-571.418000000000,-571.417000000000,-565.553000000000,-559.689000000000,-553.824000000000,-547.960000000000,-542.096000000000,-536.232000000000,-530.368000000000,-524.504000000000,-518.639000000000,-512.775000000000,-506.911000000000,-501.047000000000,-495.183000000000,-489.319000000000,-483.454000000000,-477.590000000000,-471.726000000000,-465.862000000000,-459.998000000000,-454.133000000000,-448.269000000000,-442.405000000000,-436.541000000000,-430.677000000000,-424.813000000000,-418.948000000000,-413.084000000000,-407.220000000000,-401.356000000000,-395.492000000000,-389.628000000000,-383.763000000000,-377.899000000000,-372.035000000000,-366.171000000000,-360.307000000000,-354.443000000000,-348.578000000000,-342.714000000000,-336.850000000000,-330.986000000000,-325.122000000000,-319.257000000000,-313.393000000000,-307.529000000000,-301.665000000000,-295.801000000000,-289.937000000000,-284.072000000000,-278.208000000000,-272.344000000000,-266.480000000000,-260.616000000000,-254.752000000000,-248.887000000000,-243.023000000000,-237.159000000000,-231.295000000000,-225.431000000000,-219.566000000000,-213.702000000000,-207.838000000000,-201.974000000000,-196.110000000000,-190.246000000000,-184.381000000000,-178.517000000000,-172.653000000000,-166.789000000000,-160.925000000000,-155.061000000000,-149.196000000000,-143.332000000000,-137.468000000000,-131.604000000000,-125.740000000000,-119.876000000000,-114.011000000000,-108.147000000000,-102.283000000000,-96.4188000000000,-90.5546000000000,-84.6905000000000,-78.8263000000000,-72.9621000000000,-67.0979000000000,-61.2338000000000,-55.3696000000000,-49.5054000000000,-43.6412000000000,-37.7771000000000,-31.9129000000000,-26.0487000000000,-20.1845000000000,-14.3204000000000,-8.45620000000000,-2.59202000000000,3.27215000000000,9.13633000000000,15.0005000000000,20.8647000000000,26.7288000000000,32.5930000000000,38.4572000000000,44.3214000000000,50.1855000000000,56.0497000000000,61.9139000000000,67.7781000000000,73.6422000000000,79.5064000000000,85.3706000000000,91.2348000000000,97.0989000000000,102.963000000000,108.827000000000,114.691000000000,120.556000000000,126.420000000000,132.284000000000,138.148000000000,144.012000000000,149.877000000000,155.741000000000,161.605000000000,167.469000000000,173.333000000000,179.197000000000,185.062000000000,190.926000000000,196.790000000000,202.654000000000,208.518000000000,214.382000000000,220.247000000000,226.111000000000,231.975000000000,237.839000000000,243.703000000000,249.567000000000,255.432000000000,261.296000000000,267.160000000000,273.024000000000,278.888000000000,284.753000000000,290.617000000000,296.481000000000,302.345000000000,308.209000000000,314.073000000000,319.938000000000,325.802000000000,331.666000000000,337.530000000000,343.394000000000,349.258000000000,355.123000000000,360.987000000000,366.851000000000,372.715000000000,378.579000000000,384.444000000000,390.308000000000,396.172000000000,402.036000000000,407.900000000000,413.764000000000,419.629000000000,425.493000000000,431.357000000000,437.221000000000,443.085000000000,448.949000000000,454.814000000000,460.678000000000,466.542000000000,472.406000000000,478.270000000000,484.134000000000,489.999000000000,495.863000000000,501.727000000000,507.591000000000,513.455000000000,519.320000000000,525.184000000000,531.048000000000,536.912000000000,542.776000000000,548.640000000000,554.505000000000,560.369000000000,566.233000000000,571.418];%方向盘转角
Delta=(DeltaR+DeltaL)/2;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%考虑角度大的情况下，角度简化带来的误差，计算不同曲率下，预瞄偏差x与预瞄距离d比值 xtod 对应的转向角系数（1+1/cos(theta)） 查表
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
i=0:0.001:1;
Theta=i*pi/2;
XtoD=sin(Theta)./(1+cos(Theta));
Factor=1+cos(Theta);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%模型参数
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
K_PreviewDistancemin = 3;                                   %最小预瞄距离
K_PreviewTime=1;                                            %预瞄时间1s
K_WheelBase =3.088;                                         %轴距
LatAcc=0:0.5:3;                                             %横向加速度
StbFct=0.002*ones(1,7);                                     %稳定性因数
LateralPID_LongitudinalSpeed =[0 50];
K_OrientationCompasate=0;                                   %计算的预瞄点航向角和目标航向角差值的补偿系数，需大于零
K_Lateral_P = [-4 -2];                                      %横向闭环控制PID参数
K_Lateral_I = [-0.02 -0.01];
K_Lateral_D = [0 0];
K_LongitudinalError_P = 0.4;                                %纵向闭环控制PID参数
K_LongitudinalError_I = 0.01;
K_LongitudinalError_D = 0;
K_SteeringInterventionTorque=0;

K_RoadWidth=4;                                              %道路的宽度

K_AcclerationRateLimit=5;                                   %加速度变化率限制
K_SteeringWheelRateLimit=22;                                %前轮转角变化率限制，方向盘转角速度/16
K_LonAccMax=2;                                              %纵向控制最大加速度
K_LonAccMin=-2;                                             %纵向控制最大减速度

K_ResumeWait=2;                                             %Resume发出1后等待的周期



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% EPS 限制
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
LowSteeringAngle_Speed=[0 100];
LowSteeringAngle=[-500 -500];                               %反向的方向盘转角限制
HighSteeringAngle_Speed=[0 100];
HighSteeringAngle=[500 500];                                %正向的方向盘转角限制
HighSteeringRate_Speed=[0 100];
HighSteeringRate=[-500 -500];                               %反向的方向盘转角速度限制
LowSteeringRate_Speed=[0 100];
LowSteeringRate=[500 500];                                  %正向的方向盘转角速度限制

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% 预瞄时间标定
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
VehicleSpeed_Pre=[0 100];
Curvature=[0 0.2];
PreviewTime=[1 1;1 1];


%%



%TestScenario
%TSample = 0.02;
TSample = 0.01;
Vehicle.SteerOffset =12*pi/180;
Vehicle.SteerOffset = 9*pi/180;
Vehicle.SteerOffset = 1.146*pi/180;
%ParamForVehicle
Vehicle.WheelBase = 3.048;                                                   %轴距[m]
%Vehicle.WheelBase = 2.86;
Vehicle.BodyWidth = 1.8;                                                    %车轮宽[m]
Vehicle.SteerRadio = 15.4;                                                    %转向比
Vehicle.SteerP_underS = 0.16625*pi/180;                                     %不足转向系数，前轮转角变化与侧向加速度变化值之比
Vehicle.CameraOffSet = 0.05;                                                 %摄像头偏差距离，偏左为正[m]
Vehicle.WheelSteerMax = 0.875;                                                 %最大前轮转角[rad]

%RTACondition
RTA.Max_Speed = 85/3.6;                                                       %LKA最大车速限制[m/s]
RTA.Min_Speed = 10/3.6;                                                       %LKA最小车速限制[m/s]
RTA.Min_Speed_HYS = 0;                                                        %LKA速度滞回区间
RTA.Max_Curve = 1/250;                                                    %最大控制曲率[1/m]
RTA.LKA_MIN_LM_QUAL = 2;                                                  %0：low quality (awful)
                                                                           %1：low quality (bad)
                                                                           %2：high quality (good)
                                                                           %3：high quality (great) 
                                                                           
RTA.LaneTooWide = 5;                                                       %道路过宽阈值[m]  
RTA.LaneTooNarrow = 2;                                                       %道路过窄阈值[m] 
                                                                           
%RTACondition_DriverSup
DriverSup.BRAKE_LEVEL_TH = 27.45;                                          %27.45%  LSB:0.392157
DriverSup.BRAKE_LEVEL_TH = 10;  
DriverSup.BRAKE_PEDAL_DELAY = 100;                                         %5s 20ms period
DriverSup.ACCL_PEDAL_RATE = 50.96*TSample;                                         %50.96 %/sec  100ms Period LSB:0.392157
DriverSup.ACCL_RATE_DELAY = 100;                                           %5s 20ms period
DriverSup.STEER_RATE_MAX = 147/57.2958;                                             %47 d/s  LSB:0.04375 d/s
DriverSup.STEER_RATE_DELAY =100;                                           %2s 20ms period
DriverSup.TURN_SIG_DELAY = 150;                                            %3s 20ms period
DriverSup.INTERV_DELAY = 3;                                                %两次介入的冷却时间[s]

%Algorithm
Algo.DeltaAngleSmall = 12/180*pi;                                          %i介入的方向盘转角阈值[rad]
Algo.T_preview = 2;                                                        %预瞄时间[s]
Algo.T_preview2 = 0.5;                                                        %预瞄时间[s]
Algo.CurveCutTH = 1/500;                                                   %允许curve cutting 的曲率阈值[1/m]
Algo.TTLC_in = [2 2];                                                  %控制介入的TTLC
%Algo.TTLC_in = [3 1.5]; 
Algo.TTLC_out = [4 4];                                                     %控制退出的TTLC
Algo.TTLC_Warnin = [0.2 0.1];                                              %警告进入的TTLC
Algo.OneIn_T_Step = 4.5*TSample;                                               %一次渐入力矩变化梯度
Algo.OneOut_T_Step = 4.5*TSample;                                              %一次渐出力矩变化梯度
Algo.TwoIn_T_Step = 0.15;                                               %二次渐入力矩变化系数
Algo.TwoOut_T_Step = 0.15;                                              %二次渐出力矩变化系数
Algo.Max_Lat_Acc = 4;                                                      %侧向加速度阈值
Algo.Steady_Width = 0.2;                                                   %稳定宽度阈值
Algo.Steady_Time = 150;                                                     %稳定时间阈值
Algo.Driver_Ovride_Mul = [1 1 0];                                          %驾驶员力矩对应百分比数表
Algo.Driver_Ovride_T = [0 4 8];                                            %驾驶员力矩数表
Algo.Driver_Ovride_T = [0 2 8];                                            %驾驶员力矩数表
Algo.Driver_Ovride_TMax = 2;
%Algo.P = 100;
%Algo.I = 0;
%Algo.D = 0.8;
Algo.P = 20;
Algo.I = 3;
Algo.D = 15;
Algo.PTable = [2 3 4 5 7];
%Algo.PTable = [8 8 8 8 8];
Algo.PVspd = [10 15 20 30 40]';
Algo.CrvWeightSpd = [20 30 40 50]';
Algo.CrvWeight = [1/2.7 1/1.65 1/1.34];
%Algo.CrvWeight = [1/1.65 1/1.34 1/1.2 1/1.1];

Algo.CrvWeight = [1/1.5 1/1.34 1/1.15 1/1.15];
Algo.arsmallFunc = 0.2;
Algo.MaxIntervTm = 10000;                                                    %最大介入时间[s]
Algo.MaxIntervLatAccl = 100;                                               %最大的介入横向加速度[M/s2]
Algo.OutLaneDis = 0.7;                                                     %退出控制的车轮偏离车道线距离[m]

%EPSlimit
EPS.T_Max_ADAS = 2.5;                                                        %发送到EPS中最大限制力矩[Nm]
EPS.T_Min_ADAS = -2.5;                                                       %发送到EPS中反向最大限制力矩[Nm]

%斯坦福算法参数
kstf = 0.5;
Algo.P = 4;%12
Algo.I = 1;
Algo.D = 3;%30

Algo.PCurve = 4;%12
Algo.DCurve = 3;%30

%双重积分算法参数
Algo.PV = 25;%13
Algo.IV = 5;%5
Algo.DV = 10;%2

Algo.PVCurve = 10;%13
Algo.IVCurve = 5;%5
Algo.DVCurve = 5;%2

% Algo.P = 1;%12
% Algo.I = 0;
% Algo.D = 0;%30
% 
% Algo.PCurve = 1;%12
% Algo.DCurve = 0;%30
% 
%带修正的老算法参数
Algo.P = 20;
Algo.I = 3;
Algo.D = 15;

Algo.PCurve = 10;
Algo.DCurve = 4;

Algo.PLat = 0.8;
Algo.ILat = 0.2;
Algo.DLat = 0;

Algo.PLat = 0.4;
Algo.ILat = 0.1;
Algo.DLat = 0.05;

Algo.T_previewCurve = 2;
K_VLstopped = 2.2;
K_MaxDecelForACCDur = 0.2;
LaneChange_T =5;


%带修正的老算法参数
Algo.P = 70;
Algo.I = 3;
Algo.D = 25;

Algo.PCurve = 55;
Algo.DCurve = 15;


SingleLaneEnbl = 1;

%%
% % sim('Adas_Patac_v08a');
% %  subplot(2,1,1);
% %  plot(Data_out(:,1),Data_out(:,2),'LineWidth',2,'Color',[0 0 0.5]);
% %  grid on;
% %  hold on;
% %   plot(Data_out(:,1),Data_out(:,5),'LineWidth',2,'Color',[1 0 0]);
% %  title('LatOffset');
% %  legend('deltax','IntervFlag');
% % 
% % 
% %  subplot(2,1,2);
% %  plot(Data_out(:,1),Data_out(:,3),'LineWidth',2,'Color',[0 0 0.5]);
% %   hold on;
% %  grid on;
% %  title('DeltaAngle');
% %  legend('wheelangle');


%%ModeTransCalib
KFCAEnble = 1;
%KAccPressedTime=0;
%KDlyToResumeFrmStp=0;
%KMaxTimeToGetVehMov=0;
%KMinACCEnableSpeed=0;
%KMaxOffSwTransDur=0;
%KMaxTransDur=0;
Algo.DSafety= 2;
%KACCType = 0;




%% FSRA CALIB
%% V0.1
%% Created  jincheng  2016/01/27
TSample = 0.01;

Vehicle.WheelBase = 2.86;
Vehicle.BodyWidth = 1.8;                                                    %车轮宽[m]
Vehicle.SteerRadio = 15.4;                                                    %转向比
Vehicle.SteerP_underS = 0.16625*pi/180;                                     %不足转向系数，前轮转角变化与侧向加速度变化值之比
Vehicle.CameraOffSet = 0.05;                                                 %摄像头偏差距离，偏左为正[m]
Vehicle.WheelSteerMax = 0.875;                                                 %最大前轮转角[rad]


KACCType = 2;                                                              %% 1:ACC 2:FSRA 3:FSRA with Booster
KLowACCDisengageSpeed = 15;                                                %% KPH 
KHighACCDisengageSpeed = 190;                                              %% KPH
KMinACCEnableSpeed = 15;                                                   %% KPH
KMaxACCEnableSpeed = 120;                                                  %% KPH
KPTSupercededCheckTime = 5;                                                %% second
KSpclLowSpdDisggDrAjrEn = false;                                           %% K_SpecialLowSpeedDisengageDoorAjarEnable
KFirstGearEnable = true;
KFirstGearCheckTime = 5;                                                   %% second
KABSActiveDisengageTime = 20;                                              %% second
KTCSActiveDisengageTime = 0.5;                                             %% second                                                                    
KDriverFrontDisplay = 1;                                                 %% 0:IPC 1:HUD 2:ADU
KHUDTurnedOffTime = 1;                                                     %% second
KVSESActiveDisengageTime = 0.7;                                            %% second
KHighAccelDisengage = 4;                                                   %% mpss
KOverrideHaloTime = 3;                                                     %% second
KHighDecelDisengage = -9.75;                                               %% mpss
KPercentVisibility = 0.75;                                                 %%
KSpclLowSpdDisggStbtUnfsdEn = false;                                       %% K_SpecialLowSpeedDisengageSeatbeltUnfastenedEnable
KFCAEnable = true;
KMaxStopHoldTime = 240;                                                    %% second
KSpclLowSpdDisggPkBrkFldEn = true;                                         %% K_SpecialLowSpeedDisengageParkBrakeFailedEnable
KDecelLimitedDisengageTime = 30;                                           %% second
KSpclLowSpdDisggExtdHdFldEn = true;                                        %% K_SpecialLowSpeedDisengageExtendedHoldFailedEnable
KCIBEvtACCDisggTime = 1;                                               %% second K_CIB_Event_ACC_Disengage_Time
KDecelNotactiveDisengageTime = 0.5;                                         %% second
KEngineSpeedMax = 6000;                                                    
KEngineSpeedMin = 200;                                                     %% RPM
KEngTrqActExtRngMax = 1150;
KEngTrqActExtRngMin = -800;                                                %% NM
KSpdP = 0.1;
KSpdI = 0.1;
KSpdD = 0;
KSpdErrRstSat = 2;
KSpdPIDUpLimit = 1.8;
KSpdPIDLowLimit = -0.4;
KOvrrdOvrspdMax = 10; %%K_OverrideOverspeed 
KOvrrdOvrspdMin = 5;
KRsmOvrspdMax = 20;%%K_ResumeOverspeed 
KRsmOvrspdMin = 5;
KSetOvrspdMax = 10;
KSetOvrspdMin = 5;
KOvrspdMntnTm = 2;%%K_Overspeed_Maintain_Time 
KACCcstDcl = -0.4;%%K_ACCcoastDecel  
KRsmDclTm = 2;%%K_ResumeDecelTime 
KRsmOvrspdDcl = -1.2;%%K_ResumeOverspeedDecel
KRsmDclJk = -0.6; %%K_ResumeDeceljerk 
KCutOutAccMax = 0.7;
KCutOutAccLmtTm = 2;
KAccHCMax = 2;
KHdwyFctMax = 0.8;
KFarHdwyMin = 1.4;
KMidHdwyMin = 1.2;
KNearHdwyMin = 1;
KHdwyIncHigh = 0.1;
KHdwyIncLow = 0.05;
KACCHdwyMin = 0.5;
KACCSCDisMin = 0.5;
KAccLmtByLatAccIgnSpd = 18;
KAccClsCutInMax = 0;
KACCJerkUpper = 1;
KACCJerkLower = -5;
KSetAsrtnTm = 0.5; %%K_SETAssertionTime
KSetInatvTm = 3; %%K_SETInactiveTime 
KSpdDltAbvForSet = 10;%%K_SpeedDeltaAboveForSet
KSpdDltBlwForSet = 10;%%K_SpeedDeltaBelowForSet
KInitSpdIncTm = 0.10;%%K_InitialSpeedIncreaseTime
KMtrcSltdSpdInc = 1;%%K_MetricSelectedSpeedIncrement
KNumOfSmlInc = 3;%%K_NumberOfSmallIncrements 
KHiMtrcSltdSpdInc = 5; %%K_HighMetricSelectedSpeedIncrement 
KSpdDecTm = 0.75;%%K_SpeedDecreaseTime
KSpdIncTm = 0.75;%%K_SpeedIncreaseTime
KHdwyIndHoldTm = 5;
KHdwyRateUpper = 1;
KHdwyRateLower = -1;

KAccPressedTime = 5/TSample;
KDlyToResumeFrmStp = 2/TSample;
KMaxTimeToGetVehMov = 5/TSample;
KMinFSRAEnableSpeed = 5;%kph
KMaxOffSwTransDur = 2/TSample;
KMaxTransDur = 5/TSample;

KDeltaEbcm2Ecm = 0.3;
KDeltaEcm2Ebcm = 0.2;
KAxleTrqRateMax = 800;
KAxleTrqRateMin = -1740;
KBrkAccRateMax = 5;
KBrkAccRateMin = -5;
KDis2CmdStp = 3;
KOpenloopSpd = 5;
KDriveOffMax = 5;
KDriveOffMin = 2;
KMaxLatAcc =3;
KDriveOffDelta = 3;

ObsNum = 10;
ObsProp = 14;
KLaneWidth =3.2;
KLaneWidthObsM =4.2;
KObsMTrajConfirm =75;
KCutInMaxTime = 1/TSample;
KInLaneFactor = 0.3;
KObsMInLaneFactor = 0.1;
KObsMTLC = 0.7;